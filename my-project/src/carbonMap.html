<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üåç Global Carbon Map (Live)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body {
    background: linear-gradient(120deg, #00b894, #55efc4);
    font-family: "Poppins", sans-serif;
    color: white;
    text-align: center;
  }
  #map {
    height: 90vh;
    width: 95%;
    border-radius: 16px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    margin: 20px auto;
  }
  h1 { margin-top: 20px; }
  #legend {
    background: rgba(255, 255, 255, 0.8);
    color: #333;
    padding: 10px;
    border-radius: 10px;
    font-size: 14px;
    line-height: 1.5;
  }
</style>
</head>
<body>
<h1>üåé Global Carbon Dioxide (CO‚ÇÇ) Levels (Live)</h1>
<p>üì° Data from <a href="https://open-meteo.com/" target="_blank" style="color:white;text-decoration:underline;">Open-Meteo API</a></p>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const map = L.map('map', {
  center: [20, 0],
  zoom: 2,
  minZoom: 2,
  maxZoom: 6,
  maxBounds: [[-90, -180], [90, 180]], // lock map to world
  maxBoundsViscosity: 1.0
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// Color scale for CO2
function getColor(value) {
  return value > 500 ? "#ff0000" :
         value > 300 ? "#ff6600" :
         value > 150 ? "#ffcc00" :
         "#00cc66";
}

// Helper: approximate center of polygon
function getCenter(geometry) {
  if (geometry.type === "Polygon") {
    const coords = geometry.coordinates[0];
    let lat=0, lon=0;
    coords.forEach(c=>{ lon+=c[0]; lat+=c[1]; });
    return [lon/coords.length, lat/coords.length];
  }
  if (geometry.type === "MultiPolygon") {
    const coords = geometry.coordinates[0][0];
    let lat=0, lon=0;
    coords.forEach(c=>{ lon+=c[0]; lat+=c[1]; });
    return [lon/coords.length, lat/coords.length];
  }
  return null;
}

// Load world CO2
async function loadWorldCO2() {
  const geoUrl = "https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json";
  const geoRes = await fetch(geoUrl);
  const geoData = await geoRes.json();

  geoData.features.forEach(async (country) => {
    const center = getCenter(country.geometry);
    if (!center) return;

    const lat = center[1];
    const lon = center[0];
    const apiUrl = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=carbon_monoxide`;

    try {
      const res = await fetch(apiUrl);
      const data = await res.json();
      const values = data.hourly?.carbon_monoxide;
      if (!values) return;

      const latest = values[values.length - 1];
      const color = getColor(latest);

      L.geoJSON(country, {
        style: {
          color: "#333",
          weight: 1,
          fillColor: color,
          fillOpacity: 0.7
        }
      }).addTo(map).bindPopup(`
        <b>${country.properties.name}</b><br>
        CO‚ÇÇ (Carbon Monoxide): ${latest.toFixed(2)} ¬µg/m¬≥
      `);

    } catch (err) {
      console.log("Error loading CO2 for:", country.properties.name, err);
    }
  });
}

loadWorldCO2();

// Add legend
const legend = L.control({ position: "bottomright" });
legend.onAdd = function() {
  const div = L.DomUtil.create("div", "legend");
  div.id = "legend";
  div.innerHTML = `
    <strong>CO‚ÇÇ Concentration</strong><br>
    <i style="background:#00cc66;width:15px;height:15px;display:inline-block;border-radius:4px;"></i> Low (0‚Äì150)<br>
    <i style="background:#ffcc00;width:15px;height:15px;display:inline-block;border-radius:4px;"></i> Moderate (150‚Äì300)<br>
    <i style="background:#ff6600;width:15px;height:15px;display:inline-block;border-radius:4px;"></i> High (300‚Äì500)<br>
    <i style="background:#ff0000;width:15px;height:15px;display:inline-block;border-radius:4px;"></i> Extreme (>500)
  `;
  return div;
};
legend.addTo(map);
</script>
</body>
</html>
